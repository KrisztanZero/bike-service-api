FROM mcr.microsoft.com/mssql/server:2019-latest AS database
ENV SA_PASSWORD=BikeServiceProject
ENV ACCEPT_EULA=Y
COPY ./BikeServiceAPI/Migrations/ ./Migrations/

FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build
COPY . /app
WORKDIR /app
RUN dotnet restore
RUN dotnet publish -c Release -o out

FROM mcr.microsoft.com/dotnet/runtime:7.0 AS runtime
WORKDIR /app
COPY --from=build /app/out ./

RUN dotnet ef database update --project ./BikeServiceAPI/BikeServiceAPI.csproj --context BikeServiceDbContext --verbose